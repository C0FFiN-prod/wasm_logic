(()=>{"use strict";var e={d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};let t;function n(e,t){const n=new Float32Array(9);for(let s=0;s<3;++s)for(let o=0;o<3;++o)n[3*s+o]=e[3*s+0]*t[0+o]+e[3*s+1]*t[3+o]+e[3*s+2]*t[6+o];return n}function s(){t.viewport(0,0,V.width,V.height);const e=V.width/V.height;new Float32Array([.5,0,0,0,.5*e,0,0,0,1]),t.clearColor(0,0,0,1),t.clear(t.COLOR_BUFFER_BIT);const s=i(t,t.VERTEX_SHADER,o),a=i(t,t.FRAGMENT_SHADER,r),l=t.createProgram();if(t.attachShader(l,s),t.attachShader(l,a),t.linkProgram(l),!t.getProgramParameter(l,t.LINK_STATUS))return void console.error(t.getProgramInfoLog(l));t.useProgram(l);const c=(u=k.x,f=k.y,new Float32Array([1,0,0,0,1,0,-u,-f,1]));var u,f;const h=(d=V.width/k.zoom,m=V.height/k.zoom,new Float32Array([2/d,0,0,0,-2/m,0,-1,1,1]));var d,m;const y=new Float32Array([100,0,0,0,100,0,10,10,1]),p=n(h,c),x=n(p,y),v=t.getUniformLocation(l,"u_matrix");t.uniformMatrix3fv(v,!1,x);const w=t.createBuffer(),b=t.createBuffer(),g=t.getAttribLocation(l,"a_position");t.bindBuffer(t.ARRAY_BUFFER,w),t.enableVertexAttribArray(g),t.vertexAttribPointer(g,2,t.FLOAT,!1,0,0);const A=t.getAttribLocation(l,"a_color");t.bindBuffer(t.ARRAY_BUFFER,b),t.enableVertexAttribArray(A),t.vertexAttribPointer(A,3,t.FLOAT,!1,0,0),t.drawArrays(t.TRIANGLES,0,3)}e.d({},{UI:()=>k,Ji:()=>V}),new Float32Array([-.5,-.5,.5,-.5,0,.866]),new Float32Array([1,0,0,0,1,0,0,0,1]);const o="\nattribute vec2 a_position;\nattribute vec3 a_color;\n\nuniform mat3 u_matrix;\n\nvarying vec3 v_color;\n\nvoid main() {\n  vec3 pos = u_matrix * vec3(a_position, 1);\n  gl_Position = vec4(pos.xy, 0.0, 1.0);\n  v_color = a_color;\n}\n\n\n",r="\n    precision mediump float;\n    varying vec3 v_color;\n\n    void main() {\n    gl_FragColor = vec4(v_color, 1.0);\n    }\n";function i(e,t,n){const s=e.createShader(t);return e.shaderSource(s,n),e.compileShader(s),s}function a(e,t){let n=0;for(const s of e)t(s)&&n++;return n}function l(e,t){for(const n of e)if(!t(n))return!1;return!0}function c(e,t){for(const n of e)if(t(n))return!0;return!1}class u{first;second;constructor(e,t){this.first=e,this.second=t}}class f{length;buffer;constructor(e){this.length=0,this.buffer=new Uint32Array(Math.max(Math.ceil(e/32)||0,4))}push(e){let t=Math.trunc(this.length/32);this.buffer.length<t&&(this.buffer=new Uint32Array(this.buffer.buffer,0,t+2)),this.buffer[t]|=Number(e)<<this.length%32,++this.length}at(e){let t=Math.trunc(e/32),n=e%32;return Boolean(this.buffer[t]>>n&1)}setAt(e,t){let n=Math.trunc(e/32),s=e%32;if(n>this.buffer.length)throw RangeError(`Buffer length is ${this.buffer.length}, but row is ${n}`);(this.buffer[n]>>s&1)!=(1&Number(t))&&(this.buffer[n]^=1<<s)}resize(e){let t=Math.ceil(e/32);this.buffer=new Uint32Array(this.buffer.buffer,0,t),this.length=Math.min(this.length,e)}shift(e){let t=Number(e??0);for(let e=this.buffer.length;0!=e--;){let n=1&this.buffer[e];this.buffer[e]=this.buffer[e]>>>1|t<<31,t=n}return--this.length,t}unshift(e,t=!1){let n=Number(e??0);t?++this.length:this.length=Math.max(this.length+1,(this.buffer.length<<5)-1),t&&this.length>32*this.buffer.length&&(this.buffer=new Uint32Array(this.buffer.buffer,0,this.buffer.length<<1));for(let e=0;e<this.buffer.length;++e){let t=this.buffer[e]>>>31&1;this.buffer[e]=this.buffer[e]<<1|n,n=t}return n}}let h=1;class d{setValue(e){throw new Error("Method not implemented.")}eval(){throw new Error("Method not implemented.")}id;type;x;y;inputs;value;nextValue;constructor(e,t,n){this.id=h++,this.type=e,this.x=t,this.y=n,this.value=!1,this.nextValue=!1}addInput(e){this.inputs.add(e)}removeInput(e){this.inputs.delete(e)}computeNextValue(){this.nextValue=this.value}applyNextValue(){this.value=this.nextValue}}const m=new Map(Object.entries({AND:0,OR:1,XOR:2,NAND:3,NOR:4,XNOR:5}));class y extends d{gateType;constructor(e,t,n){super(e,t,n),this.gateType=m.get(e)||0}eval(){switch(this.gateType){case 0:this.nextValue=this.inputs.size>0&&l(this.inputs,e=>e.value);break;case 1:this.nextValue=c(this.inputs,e=>e.value);break;case 2:0===this.inputs.size?this.nextValue=!1:this.nextValue=a(this.inputs,e=>!0===e.value)%2==1;break;case 3:this.nextValue=this.inputs.size>0&&!l(this.inputs,e=>e.value);break;case 4:this.nextValue=this.inputs.size>0&&!c(this.inputs,e=>e.value);break;case 5:0===this.inputs.size?this.nextValue=!1:this.nextValue=a(this.inputs,e=>!0===e.value)%2==0;break;default:this.nextValue=!1}}}class p extends d{gateType;constructor(e,t){super("T_FLOP",e,t),this.gateType=2}eval(){(this.nextValue=a(this.inputs,e=>!0===e.value)%2==1)?this.nextValue=!this.value:this.nextValue=this.value}}class x extends d{delay;buffer;constructor(e,t){super("TIMER",e,t),this.delay=0,this.buffer=new f(128)}setDelay(e){this.delay=e}eval(){this.nextValue=this.buffer.at(this.delay),this.buffer.unshift(c(this.inputs,e=>e.value)||!1)}}class v extends d{constructor(e,t){super("BUTTON",e,t),this.value=!1,this.nextValue=!1}setValue(e){this.value=e,this.nextValue=!1}eval(){this.nextValue=!1}}class w extends d{constructor(e,t){super("SWITCH",e,t),this.value=!1,this.nextValue=!1}setValue(e){this.value=e,this.nextValue=e}eval(){this.nextValue=this.value}}class b extends d{constructor(e,t){super("OUTPUT",e,t)}eval(){this.nextValue=this.inputs.size>0&&c(this.inputs,e=>e.value)}}class g{from;to;constructor(e,t){this.from=e,this.to=t}}function A(e){return e&&"OUTPUT"===e.type}function E(e){return e&&(e instanceof v||e instanceof w)}const V=document.getElementById("circuit-canvas"),k={x:0,y:0,zoom:1},R=new class{elements;wires;tick;constructor(){this.elements=[],this.wires=new Map,this.tick=0}addElement(e){return this.elements.push(e),e}addWire(e,t){const n=`${e.id}-${t.id}`,s=`${t.id}-${e.id}`;return!this.wires.has(n)&&!this.wires.has(s)&&(this.wires.set(n,new g(e,t)),t.addInput(e),!0)}removeWire(e,t){const n=`${e.id}-${t.id}`;return!!this.wires.has(n)&&(this.wires.delete(n),t.removeInput(e),!0)}removeWiresForElement(e){const t=new Array,n=e.id;let s,o;for(const e of this.elements)void 0!==(s=this.wires.get(o=`${n}-${e.id}`))&&t.push(new u(s,o));for(const r of e.inputs)(s=this.wires.get(o=`${r.id}-${n}`))&&t.push(new u(s,o));for(const e of t)e.first.to.removeInput(e.first.from),this.wires.delete(e.second)}step(){this.tick++;for(const e of this.elements)e.eval();for(const e of this.elements)e.applyNextValue()}reset(){for(const e of this.elements)E(e)?e.setValue(!1):(e.value=!1,e.nextValue=!1);this.tick=0}};let O,T="move",M=!1,L={x:0,y:0},N={x:0,y:0},_=new Array,F=new Array,z=0,U=0,I=!1,S=!1,B=!1,P={x:0,y:0},$={x:0,y:0},X=new Set;function Y(e,t,n){const s=document.getElementById(e);s?s[t]=n:console.warn(`Element with id "${e}" not found`)}function W(e,t){const n=20*k.zoom;return{x:(k.x*k.zoom+e)/n,y:(k.y*k.zoom+t)/n}}function D(){R.step(),requestAnimationFrame(s)}function C(e,t,n){let s;const o=W(V.width/2,V.height/2),r=t||Math.round(o.x+10*Math.random()-5),i=n||Math.round(o.y+10*Math.random()-5);switch(e){case"AND":case"OR":case"XOR":case"NAND":case"NOR":case"XNOR":s=new y(e,r,i);break;case"T_FLOP":s=new p(r,i);break;case"TIMER":s=new x(r,i);break;case"BUTTON":s=new v(r,i);break;case"SWITCH":s=new w(r,i);break;case"OUTPUT":s=new b(r,i);break;default:return null}return R.addElement(s)}function H(e){const t=new Set;for(const n of R.elements){const s=n.x,o=n.y;s+1>=e.x&&s<=e.x+e.width&&o+1>=e.y&&o<=e.y+e.height&&t.add(n)}return t}function j(){_=[],F=[],X.clear()}function K(){document.querySelectorAll("#toolbar .tool-button").forEach(e=>{e.classList.remove("active")}),document.getElementById(`tool-${T}`)?.classList.add("active")}window.onload=()=>{K(),function(){let e=V.getContext("webgl");if(!e)throw"WebGL context could not be loaded";t=e}(),V.width=window.innerWidth,V.height=window.innerHeight-(document.querySelector("header")?.offsetHeight||0),s()},window.addEventListener("resize",()=>{V.width=window.innerWidth,V.height=window.innerHeight-(document.querySelector("header")?.offsetHeight||0),s()}),V.addEventListener("mousedown",e=>{if(z=e.offsetX,U=e.offsetY,1===e.button)N.x=z,N.y=U,I=!0;else{const t=function(e,t){const{x:n,y:s}=W(e,t);for(const e of R.elements){const t=e.x,o=e.y;if(t<=n&&n<t+1&&o<=s&&s<o+1)return e}return null}(z,U);if(t){if("connect"===T){if(0===e.button){const e=_.indexOf(t);-1===e&&A(t)?_.push(t):_.splice(e,1)}else if(2===e.button){const e=F.indexOf(t);-1===e&&E(t)?F.push(t):F.splice(e,1)}}else if(0===e.button)X.has(t)?e.shiftKey&&X.delete(t):(e.shiftKey||j(),X.add(t)),N.x=z,N.y=U,L=W(z,U),B=!0;else if(2===e.button)if(t instanceof w)t.setValue(!t.value);else if(t instanceof v)t.setValue(!0);else if(t instanceof x){let e=prompt(`Set delay (now ${t.delay} ticks):`);""!==e&&t.setDelay(Number(e))}}else"move"===T&&0===e.button&&(S=!0,P={x:e.offsetX,y:e.offsetY},$={x:e.offsetX,y:e.offsetY},console.log(e.clientY-V.getBoundingClientRect().top,e.offsetY),e.shiftKey||j())}s()}),V.addEventListener("mousemove",e=>{z=e.offsetX,U=e.offsetY;let t=W(z,U);if(I)k.x-=(e.offsetX-N.x)/k.zoom,k.y-=(e.offsetY-N.y)/k.zoom,N.x=e.offsetX,N.y=e.offsetY,s();else if(B&&X.size>0){const e={x:Math.round(t.x)-Math.round(L.x),y:Math.round(t.y)-Math.round(L.y)};for(const t of X)t.x+=e.x,t.y+=e.y;L.x=t.x,L.y=t.y,s()}else if(S){$={x:e.offsetX,y:e.offsetY};const t=function(){const e=W(P.x,P.y),t=W($.x,$.y);return{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y),width:Math.abs(e.x-t.x),height:Math.abs(e.y-t.y)}}();e.ctrlKey&&e.shiftKey?H(t).forEach(e=>X.delete(e)):e.shiftKey?H(t).forEach(e=>X.add(e)):X=H(t),s()}}),window.addEventListener("mouseup",e=>{(S||B)&&(S=!1,B=!1,s())}),V.addEventListener("mouseout",e=>{I=!1,S=!1,B=!1}),V.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY<0?1.1:1/1.1,n=e.offsetX,o=e.offsetY,r=k.x+n/k.zoom,i=k.y+o/k.zoom;k.zoom*=t,k.x=r-n/k.zoom,k.y=i-o/k.zoom,s()},{passive:!1}),V.addEventListener("mouseup",e=>{I&&1===e.button?I=!1:((S||B)&&(S=!1,B=!1,s()),e.stopPropagation())}),document.addEventListener("keydown",e=>{if("Delete"===e.key&&X.size>0){for(const e of X)R.removeWiresForElement(e);R.elements=R.elements.filter(e=>!X.has(e)),j(),s()}else"connect"===T&&("Enter"===e.key&&_.length>0&&F.length>0?function(){if(0!==_.length&&0!==F.length){for(const e of _)for(const t of F)e!==t&&A(e)&&E(t)&&R.addWire(e,t);j(),s()}}():"Backspace"===e.key?function(){if(0!==_.length&&0!==F.length){for(const e of _)for(const t of F)R.removeWire(e,t);j(),s()}}():"Escape"===e.key&&(j(),s()))}),["add-and","add-or","add-xor","add-nand","add-nor","add-xnor","add-t_flop","add-timer","add-button","add-switch","add-output"].forEach(e=>{const t=document.getElementById(e);t&&(t.onclick=()=>{C(e.replace("add-","").toUpperCase(),null,null),s()})}),Y("tool-move","onclick",e=>{T="move",j(),K(),s()}),Y("tool-connect","onclick",e=>{T="connect",j(),K(),s()}),Y("clear-canvas","onclick",function(){confirm("Вы уверены, что хотите очистить холст?")&&(R.elements=[],R.wires.clear(),j(),s())}),Y("start-sim","onclick",e=>{M||(M=!0,O=setInterval(D,25))}),Y("step-sim","onclick",e=>{M=!1,clearInterval(O),D()}),Y("stop-sim","onclick",e=>{M=!1,clearInterval(O)}),Y("save-scheme","onclick",e=>{const t=JSON.stringify({elements:R.elements.map(e=>({id:e.id,type:e.type,x:e.x,y:e.y})),wires:Array.from(R.wires.values()).map(e=>({from:e.from.id,to:e.to.id}))}),n=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download="circuit.json",o.click(),URL.revokeObjectURL(s)}),Y("load-scheme","onclick",e=>{document.getElementById("file-input")?.click()}),Y("file-input","onchange",e=>{const t=e.target.files?.[0];if(!t)return;const n=new FileReader;n.onload=e=>{const t=e.target?.result;if("string"==typeof t)try{!function(e){R.elements=[],R.wires.clear();const t=new Map;for(const n of e.elements){let e=C(n.type,n.x,n.y);e&&(e.id=n.id,t.set(n.id,e))}for(const n of e.wires){const e=t.get(n.from),s=t.get(n.to);e&&s&&R.addWire(e,s)}}(JSON.parse(t)),s()}catch(e){console.error("Error parsing JSON:",e)}else console.error("Expected string result from FileReader")},n.readAsText(t)}),V.addEventListener("contextmenu",e=>{e.preventDefault()})})();