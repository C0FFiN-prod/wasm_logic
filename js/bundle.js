(()=>{"use strict";var e={d:(t,n)=>{for(var s in n)e.o(n,s)&&!e.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};e.d({},{UI:()=>T,Ji:()=>k,_0:()=>P,ej:()=>V,oZ:()=>C,Pq:()=>W,Dh:()=>H,e9:()=>D,w0:()=>N,mv:()=>z,qv:()=>B,B7:()=>$,UK:()=>F,m8:()=>j});const t=new Map(Object.entries({and:new Path2D("M21 11C21 5.47715 16.5228 1 11 1C5.47715 1 1 5.47715 1 11V21H21V11Z"),output:new Path2D("M11 21C5.47715 21 0.999999 16.5228 0.999999 11C1 5.47715 5.47715 0.999999 11 1C16.5228 1 21 5.47715 21 11C21 16.5228 16.5228 21 11 21Z"),button:new Path2D("M11 21C5.47715 21 0.999999 16.5228 0.999999 11C1 5.47715 5.47715 0.999999 11 1C16.5228 1 21 5.47715 21 11C21 16.5228 16.5228 21 11 21Z"),nand:new Path2D("M9.00968 3.19808C4.44038 4.12087 1 8.15866 1 13V21H21V13C21 8.15866 17.5596 4.12087 12.9903 3.19808M9.00968 3.19808C9.10914 4.20966 9.96227 5 11 5C12.0377 5 12.8909 4.20966 12.9903 3.19808M9.00968 3.19808C9.00328 3.13292 9 3.06684 9 3C9 1.89543 9.89543 1 11 1C12.1046 1 13 1.89543 13 3C13 3.06684 12.9967 3.13292 12.9903 3.19808"),nor:new Path2D("M9.04862 3.44027C5.33718 4.98753 1 10.3343 1 15V21C1 21 6.73344 17.8 11 17.8C15.2666 17.8 21 21 21 21V15C21 10.3343 16.6628 4.98753 12.9514 3.44027M9.04862 3.44027C9.24917 4.33303 10.0467 5 11 5C11.9533 5 12.7508 4.33303 12.9514 3.44027M9.04862 3.44027C9.01679 3.29861 9 3.15127 9 3C9 1.89543 9.89543 1 11 1C12.1046 1 13 1.89543 13 3C13 3.15127 12.9832 3.29861 12.9514 3.44027"),or:new Path2D("M21 13C21 7.47715 14.9228 1 11 1C7.07715 1 1 7.47715 1 13V21C1 21 6.73344 17.8 11 17.8C15.2666 17.8 21 21 21 21V13Z"),switch:new Path2D("M11 21C16.5228 21 21 16.5228 21 11C21 5.47715 16.5228 1 11 1M11 21C5.47715 21 1 16.5228 1 11C1 5.47715 5.47715 1 11 1M11 21V1"),t_flop:new Path2D("M11 2L21 22H1L11 2Z"),timer:new Path2D("M21 11H11M21 11C21 8.23858 19.8807 5.73858 18.0711 3.92893M21 11C21 13.7614 19.8807 16.2614 18.0711 18.0711M11 21V11M11 21C8.23858 21 5.73858 19.8807 3.92893 18.0711M11 21C13.7614 21 16.2614 19.8807 18.0711 18.0711M1 11H11M1 11C1 13.7614 2.11929 16.2614 3.92893 18.0711M1 11C1 8.23858 2.11929 5.73858 3.92893 3.92893M11 1V11M11 1C13.7614 1 16.2614 2.11929 18.0711 3.92893M11 1C8.23858 1 5.73858 2.11929 3.92893 3.92893M11 11L3.92893 18.0711M11 11L18.0711 3.92893M11 11L18.0711 18.0711M11 11L3.92893 3.92893"),xnor:new Path2D("M21 16.2C21 16.2 15.2666 13 11 13C6.73344 13 1 16.2 1 16.2M21 16.2V21C21 21 15.2666 17.8 11 17.8C6.73344 17.8 1 21 1 21V16.2M21 16.2V15C21 10.3343 16.6628 4.98753 12.9514 3.44027M1 16.2V15C1 10.3343 5.33718 4.98753 9.04862 3.44027M9.04862 3.44027C9.24917 4.33303 10.0467 5 11 5C11.9533 5 12.7508 4.33303 12.9514 3.44027M9.04862 3.44027C9.01679 3.29861 9 3.15127 9 3C9 1.89543 9.89543 1 11 1C12.1046 1 13 1.89543 13 3C13 3.15127 12.9832 3.29861 12.9514 3.44027"),xor:new Path2D("M21 16.2V13C21 7.47715 14.9228 1 11 1C7.07715 1 1 7.47715 1 13V16.2M21 16.2C21 16.2 15.2666 13 11 13C6.73344 13 1 16.2 1 16.2M21 16.2V21C21 21 15.2666 17.8 11 17.8C6.73344 17.8 1 21 1 21V16.2")}));function n(e,t){let n=0;for(const s of e)t(s)&&n++;return n}function s(e,t){for(const n of e)if(!t(n))return!1;return!0}function o(e,t){for(const n of e)if(t(n))return!0;return!1}t.get("button")?.addPath(new Path2D("M11 16.2C8.12812 16.2 5.8 13.8719 5.8 11C5.8 8.12812 8.12812 5.8 11 5.8C13.8719 5.8 16.2 8.12812 16.2 11C16.2 13.8719 13.8719 16.2 11 16.2Z"));class i{first;second;constructor(e,t){this.first=e,this.second=t}}class r{length;buffer;constructor(e){this.length=0,this.buffer=new Uint32Array(Math.max(Math.ceil(e/32)||0,4))}push(e){let t=Math.trunc(this.length/32);this.buffer.length<t&&(this.buffer=new Uint32Array(this.buffer.buffer,0,t+2)),this.buffer[t]|=Number(e)<<this.length%32,++this.length}at(e){let t=Math.trunc(e/32),n=e%32;return Boolean(this.buffer[t]>>n&1)}setAt(e,t){let n=Math.trunc(e/32),s=e%32;if(n>this.buffer.length)throw RangeError(`Buffer length is ${this.buffer.length}, but row is ${n}`);(this.buffer[n]>>s&1)!=(1&Number(t))&&(this.buffer[n]^=1<<s)}resize(e){let t=Math.ceil(e/32);this.buffer=new Uint32Array(this.buffer.buffer,0,t),this.length=Math.min(this.length,e)}shift(e){let t=Number(e??0);for(let e=this.buffer.length;0!=e--;){let n=1&this.buffer[e];this.buffer[e]=this.buffer[e]>>>1|t<<31,t=n}return--this.length,t}unshift(e,t=!1){let n=Number(e??0);t?++this.length:this.length=Math.max(this.length+1,(this.buffer.length<<5)-1),t&&this.length>32*this.buffer.length&&(this.buffer=new Uint32Array(this.buffer.buffer,0,this.buffer.length<<1));for(let e=0;e<this.buffer.length;++e){let t=this.buffer[e]>>>31&1;this.buffer[e]=this.buffer[e]<<1|n,n=t}return n}}let a=1;class l{setValue(e){throw new Error("Method not implemented.")}eval(){throw new Error("Method not implemented.")}id;type;x;y;inputs;value;nextValue;constructor(e,t,n){this.id=a++,this.type=e,this.x=t,this.y=n,this.value=!1,this.nextValue=!1}addInput(e){this.inputs.add(e)}removeInput(e){this.inputs.delete(e)}computeNextValue(){this.nextValue=this.value}applyNextValue(){this.value=this.nextValue}}const f=new Map(Object.entries({AND:0,OR:1,XOR:2,NAND:3,NOR:4,XNOR:5}));class h extends l{gateType;constructor(e,t,n){super(e,t,n),this.gateType=f.get(e)||0}eval(){switch(this.gateType){case 0:this.nextValue=this.inputs.size>0&&s(this.inputs,e=>e.value);break;case 1:this.nextValue=o(this.inputs,e=>e.value);break;case 2:0===this.inputs.size?this.nextValue=!1:this.nextValue=n(this.inputs,e=>!0===e.value)%2==1;break;case 3:this.nextValue=this.inputs.size>0&&!s(this.inputs,e=>e.value);break;case 4:this.nextValue=this.inputs.size>0&&!o(this.inputs,e=>e.value);break;case 5:0===this.inputs.size?this.nextValue=!1:this.nextValue=n(this.inputs,e=>!0===e.value)%2==0;break;default:this.nextValue=!1}}}class c extends l{gateType;constructor(e,t){super("T_FLOP",e,t),this.gateType=2}eval(){(this.nextValue=n(this.inputs,e=>!0===e.value)%2==1)?this.nextValue=!this.value:this.nextValue=this.value}}class u extends l{delay;buffer;constructor(e,t){super("TIMER",e,t),this.delay=0,this.buffer=new r(128)}setDelay(e){this.delay=e}eval(){this.nextValue=this.buffer.at(this.delay),this.buffer.unshift(o(this.inputs,e=>e.value)||!1)}}class d extends l{constructor(e,t){super("BUTTON",e,t),this.value=!1,this.nextValue=!1}setValue(e){this.value=e,this.nextValue=!1}eval(){this.nextValue=!1}}class y extends l{constructor(e,t){super("SWITCH",e,t),this.value=!1,this.nextValue=!1}setValue(e){this.value=e,this.nextValue=e}eval(){this.nextValue=this.value}}class m extends l{constructor(e,t){super("OUTPUT",e,t)}eval(){this.nextValue=this.inputs.size>0&&o(this.inputs,e=>e.value)}}class x{from;to;constructor(e,t){this.from=e,this.to=t}}function p(e){return e&&"OUTPUT"===e.type}function w(e){return e&&(e instanceof d||e instanceof y)}function b(){if(V.setTransform(1,0,0,1,0,0),V.clearRect(0,0,k.width,k.height),V.translate(-T.x*T.zoom,-T.y*T.zoom),V.scale(T.zoom,T.zoom),function(){V.strokeStyle="#000",V.lineWidth=1/T.zoom;const e=T.x,t=T.y,n=T.x+k.width/T.zoom,s=T.y+k.height/T.zoom,o=Math.floor(e/C)*C,i=Math.floor(t/C)*C;for(let e=o;e<=n;e+=C)V.beginPath(),V.moveTo(e,t),V.lineTo(e,s),V.stroke();for(let t=i;t<=s;t+=C)V.beginPath(),V.moveTo(e,t),V.lineTo(n,t),V.stroke()}(),"connect"===z){V.strokeStyle="#888",V.lineWidth=2,V.beginPath();for(const e of P.wires.values()){let t=j(e.from.x,e.from.y),n=j(e.to.x,e.to.y);V.moveTo(t.x+C,t.y+.5*C),V.lineTo(n.x,n.y+.5*C)}if(V.stroke(),D.length>0&&N.length>0){V.strokeStyle="#fa0",V.lineWidth=2,V.beginPath();for(const e of D)for(const t of N){let n=j(e.x,e.y),s=j(t.x,t.y);V.moveTo(n.x+C,n.y+.5*C),V.lineTo(s.x,s.y+.5*C)}V.stroke()}}for(const e of P.elements)g(e);V.lineWidth=3;for(const e of D)v(e,"#0f0");for(const e of N)v(e,"#f00");for(const e of H)v(e,"#19f");if(V.setTransform(1,0,0,1,0,0),W){V.strokeStyle="#19f",V.lineWidth=2,V.setLineDash([5,5]);const e=Math.min($.x,B.x),t=Math.min($.y,B.y),n=Math.abs(B.x-$.x),s=Math.abs(B.y-$.y);V.strokeRect(e,t,n,s),V.setLineDash([])}M(F(0,0),"#f00"),M({x:k.width/2,y:k.height/2},"#0f0")}function v(e,t){V.strokeStyle=t,V.lineWidth=2,V.strokeRect(e.x*C-2,e.y*C-2,C+4,C+4)}function g(e){const n=e.x*C,s=e.y*C;V.save(),V.translate(n,s),V.strokeStyle="#555",V.fillStyle=e.value?"#15c":"#333",V.lineWidth=2/T.zoom,V.beginPath(),V.rect(0,0,C,C),V.fill(),V.stroke(),e.value&&(V.beginPath(),V.arc(.5*C,.5*C,5,0,2*Math.PI),"OUTPUT"===e.type&&(V.fillStyle="#aa0"),"BUTTON"!==e.type&&"SWITCH"!==e.type||(V.fillStyle="#0c0"),V.fill(),V.stroke());let o=t.get(e.type.toLowerCase());o&&function(e,t,n,s,o="black",i=1,r=null){V.save(),V.translate(t,n),V.scale(s,s),r&&(V.fillStyle=r,V.fill(e)),V.lineWidth=i/s,V.strokeStyle=o,V.stroke(e),V.restore()}(o,5,5,10/22,e.value?"#59f":"#eee",1),"connect"===z&&(w(e)?p(e)||(V.beginPath(),V.arc(C,.5*C,2,0,2*Math.PI),V.fillStyle=e.value?"#0a0":"#aaa",V.fill(),V.stroke()):(V.beginPath(),V.arc(0,.5*C,2,0,2*Math.PI),V.fillStyle=e.value?"#0a0":"#aaa",V.fill(),V.stroke())),V.restore()}function M(e,t){V.beginPath(),V.arc(e.x,e.y,2,0,2*Math.PI),V.fillStyle=t,V.strokeStyle=t,V.fill(),V.stroke()}const C=20,k=document.getElementById("circuit-canvas"),V=k.getContext("2d"),T={x:0,y:0,zoom:1},P=new class{elements;wires;tick;constructor(){this.elements=[],this.wires=new Map,this.tick=0}addElement(e){return this.elements.push(e),e}addWire(e,t){const n=`${e.id}-${t.id}`,s=`${t.id}-${e.id}`;return!this.wires.has(n)&&!this.wires.has(s)&&(this.wires.set(n,new x(e,t)),t.addInput(e),!0)}removeWire(e,t){const n=`${e.id}-${t.id}`;return!!this.wires.has(n)&&(this.wires.delete(n),t.removeInput(e),!0)}removeWiresForElement(e){const t=new Array,n=e.id;let s,o;for(const e of this.elements)void 0!==(s=this.wires.get(o=`${n}-${e.id}`))&&t.push(new i(s,o));for(const r of e.inputs)(s=this.wires.get(o=`${r.id}-${n}`))&&t.push(new i(s,o));for(const e of t)e.first.to.removeInput(e.first.from),this.wires.delete(e.second)}step(){this.tick++;for(const e of this.elements)e.eval();for(const e of this.elements)e.applyNextValue()}reset(){for(const e of this.elements)w(e)?e.setValue(!1):(e.value=!1,e.nextValue=!1);this.tick=0}};let E,z="move",O=!1,S={x:0,y:0},L={x:0,y:0},D=new Array,N=new Array,I=0,U=0,R=!1,W=!1,A=!1,$={x:0,y:0},B={x:0,y:0},H=new Set;function X(e,t,n){const s=document.getElementById(e);s?s[t]=n:console.warn(`Element with id "${e}" not found`)}function Y(e,t){const n=T.zoom*C;return{x:(T.x*T.zoom+e)/n,y:(T.y*T.zoom+t)/n}}function j(e,t){return{x:e*C,y:t*C}}function F(e,t){const n=T.zoom*C;return{x:e*n-T.x*T.zoom,y:t*n-T.y*T.zoom}}function K(){P.step(),requestAnimationFrame(b)}function Z(e,t,n){let s;const o=Y(k.width/2,k.height/2),i=t||Math.round(o.x+10*Math.random()-5),r=n||Math.round(o.y+10*Math.random()-5);switch(e){case"AND":case"OR":case"XOR":case"NAND":case"NOR":case"XNOR":s=new h(e,i,r);break;case"T_FLOP":s=new c(i,r);break;case"TIMER":s=new u(i,r);break;case"BUTTON":s=new d(i,r);break;case"SWITCH":s=new y(i,r);break;case"OUTPUT":s=new m(i,r);break;default:return null}return P.addElement(s)}function q(e){const t=new Set;for(const n of P.elements){const s=n.x,o=n.y;s+1>=e.x&&s<=e.x+e.width&&o+1>=e.y&&o<=e.y+e.height&&t.add(n)}return t}function _(){D=[],N=[],H.clear()}function J(){document.querySelectorAll("#toolbar .tool-button").forEach(e=>{e.classList.remove("active")}),document.getElementById(`tool-${z}`)?.classList.add("active")}window.onload=()=>{k.width=window.innerWidth,k.height=window.innerHeight-(document.querySelector("header")?.offsetHeight||0),b()},window.addEventListener("resize",()=>{k.width=window.innerWidth,k.height=window.innerHeight-(document.querySelector("header")?.offsetHeight||0),b()}),k.addEventListener("mousedown",e=>{if(I=e.offsetX,U=e.offsetY,1===e.button)L.x=I,L.y=U,R=!0;else{const t=function(e,t){const{x:n,y:s}=Y(e,t);for(const e of P.elements){const t=e.x,o=e.y;if(t<=n&&n<t+1&&o<=s&&s<o+1)return e}return null}(I,U);if(t){if("connect"===z){if(0===e.button){const e=D.indexOf(t);-1===e&&p(t)?D.push(t):D.splice(e,1)}else if(2===e.button){const e=N.indexOf(t);-1===e&&w(t)?N.push(t):N.splice(e,1)}}else if(0===e.button)H.has(t)?e.shiftKey&&H.delete(t):(e.shiftKey||_(),H.add(t)),L.x=I,L.y=U,S=Y(I,U),A=!0;else if(2===e.button)if(t instanceof y)t.setValue(!t.value);else if(t instanceof d)t.setValue(!0);else if(t instanceof u){let e=prompt(`Set delay (now ${t.delay} ticks):`);""!==e&&t.setDelay(Number(e))}}else"move"===z&&0===e.button&&(W=!0,$={x:e.offsetX,y:e.offsetY},B={x:e.offsetX,y:e.offsetY},console.log(e.clientY-k.getBoundingClientRect().top,e.offsetY),e.shiftKey||_())}b()}),k.addEventListener("mousemove",e=>{I=e.offsetX,U=e.offsetY;let t=Y(I,U);if(R)T.x-=(e.offsetX-L.x)/T.zoom,T.y-=(e.offsetY-L.y)/T.zoom,L.x=e.offsetX,L.y=e.offsetY,b();else if(A&&H.size>0){const e={x:Math.round(t.x)-Math.round(S.x),y:Math.round(t.y)-Math.round(S.y)};for(const t of H)t.x+=e.x,t.y+=e.y;S.x=t.x,S.y=t.y,b()}else if(W){B={x:e.offsetX,y:e.offsetY};const t=function(){const e=Y($.x,$.y),t=Y(B.x,B.y);return{x:Math.min(e.x,t.x),y:Math.min(e.y,t.y),width:Math.abs(e.x-t.x),height:Math.abs(e.y-t.y)}}();e.ctrlKey&&e.shiftKey?q(t).forEach(e=>H.delete(e)):e.shiftKey?q(t).forEach(e=>H.add(e)):H=q(t),b()}}),window.addEventListener("mouseup",e=>{(W||A)&&(W=!1,A=!1,b())}),k.addEventListener("mouseout",e=>{R=!1,W=!1,A=!1}),k.addEventListener("wheel",e=>{e.preventDefault();const t=e.deltaY<0?1.1:1/1.1,n=e.offsetX,s=e.offsetY,o=T.x+n/T.zoom,i=T.y+s/T.zoom;T.zoom*=t,T.x=o-n/T.zoom,T.y=i-s/T.zoom,b()},{passive:!1}),k.addEventListener("mouseup",e=>{R&&1===e.button?R=!1:((W||A)&&(W=!1,A=!1,b()),e.stopPropagation())}),document.addEventListener("keydown",e=>{if("Delete"===e.key&&H.size>0){for(const e of H)P.removeWiresForElement(e);P.elements=P.elements.filter(e=>!H.has(e)),_(),b()}else"connect"===z&&("Enter"===e.key&&D.length>0&&N.length>0?function(){if(0!==D.length&&0!==N.length){for(const e of D)for(const t of N)e!==t&&p(e)&&w(t)&&P.addWire(e,t);_(),b()}}():"Backspace"===e.key?function(){if(0!==D.length&&0!==N.length){for(const e of D)for(const t of N)P.removeWire(e,t);_(),b()}}():"Escape"===e.key&&(_(),b()))}),["add-and","add-or","add-xor","add-nand","add-nor","add-xnor","add-t_flop","add-timer","add-button","add-switch","add-output"].forEach(e=>{const t=document.getElementById(e);t&&(t.onclick=()=>{Z(e.replace("add-","").toUpperCase(),null,null),b()})}),X("tool-move","onclick",e=>{z="move",_(),J(),b()}),X("tool-connect","onclick",e=>{z="connect",_(),J(),b()}),X("clear-canvas","onclick",function(){confirm("Вы уверены, что хотите очистить холст?")&&(P.elements=[],P.wires.clear(),_(),b())}),X("start-sim","onclick",e=>{O||(O=!0,E=setInterval(K,25))}),X("step-sim","onclick",e=>{O=!1,clearInterval(E),K()}),X("stop-sim","onclick",e=>{O=!1,clearInterval(E)}),X("save-scheme","onclick",e=>{const t=JSON.stringify({elements:P.elements.map(e=>({id:e.id,type:e.type,x:e.x,y:e.y})),wires:Array.from(P.wires.values()).map(e=>({from:e.from.id,to:e.to.id}))}),n=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download="circuit.json",o.click(),URL.revokeObjectURL(s)}),X("load-scheme","onclick",e=>{document.getElementById("file-input")?.click()}),X("file-input","onchange",e=>{const t=e.target.files?.[0];if(!t)return;const n=new FileReader;n.onload=e=>{const t=e.target?.result;if("string"==typeof t)try{!function(e){P.elements=[],P.wires.clear();const t=new Map;for(const n of e.elements){let e=Z(n.type,n.x,n.y);e&&(e.id=n.id,t.set(n.id,e))}for(const n of e.wires){const e=t.get(n.from),s=t.get(n.to);e&&s&&P.addWire(e,s)}}(JSON.parse(t)),b()}catch(e){console.error("Error parsing JSON:",e)}else console.error("Expected string result from FileReader")},n.readAsText(t)}),k.addEventListener("contextmenu",e=>{e.preventDefault()}),J(),b()})();